name: Update F-Droid

on: [workflow_call, workflow_dispatch]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  fdroid:
    name: Update F-Droid
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 17
      - name: F-Droid
        run: |
          sudo add-apt-repository ppa:fdroid/fdroidserver
          sudo apt-get update
          sudo apt-get install apksigner fdroidserver --no-install-recommends
          cd fdroid
          echo "${{ secrets.KEYSTORE }}" | base64 -d >keystore.p12
          chmod 0600 config.yml
          fdroid update -c --pretty
      - uses: stefanzweifel/git-auto-commit-action@v4
  deploy:
    needs: fdroid
    name: Deploy to Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Pages
        uses: actions/configure-pages@v2
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          # Upload entire repository
          path: './fdroid/repo'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1
